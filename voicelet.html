<!DOCTYPE html>
<html>
<head>
	<meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name=apple-mobile-web-app-capable content=yes>
	<meta name=apple-mobile-web-app-status-bar-style content=black>
	
	<style>
		#listen, select {	
			font-size: 24pt;}
		#content {		
			font-size: 16pt;}
		#speed { 			
			font-size: 18pt}
		#clear, #share  {	
			font-size: 18pt;}

		@media screen and (max-width: 600px) {
			#clear, #share  {
				font-size: 12pt;
			}
			#content {
				font-size: 14pt;
			}
		}
		
		body {
			display: flex;
			flex-direction: column;
			height: 100vh;
			margin: 0;
			background-color: #260101;
			color: #eee;
		}
		select {
			background-color: #260101;
		}

		#buttons-container, #dropdown-container { 
			display: flex;
			flex-direction: row; 
			justify-content: center; 
			align-items: center; 
			flex-wrap: nowrap;

			display: flex;
			flex-direction: row;
		}
		#dropdown-container { 
			justify-content: left; 
		}

		#speed, #drop-down, #content, #listen, #clear, #share {
			margin: 5px;
			border: none;
			flex-grow: 0;
			flex-shrink: 0;

		}		
		#drop-down { 
			flex-basis: 70%; 
			color: #fff;
			max-width: 70%;
		}
		
		#speed { 
			flex-basis: 20%; 
			color: #ddd;
		}
		
		#content  { 
			flex-basis: 80%; 
			overflow: auto;
		}

		pre, code{
			color: #bbb;
			font-size: 80%;
			white-space: pre-wrap;
		}
		
		

		#clear, #share { 
			flex-basis: 15%; 
			min-height: 20pt;
			border-radius: 5px;
			background-color: #275950;
			color: #eee;
		}
		#listen { 
			flex-basis: 60%; 
			min-height: 40pt;
			border-radius: 100px;
			background-color: #2A8C82;
			color: #fff;

		}
		
	</style>
</head>
<body>
	<div id="dropdown-container">
		<select id="drop-down"></select>
		<select id="speed">
			<option value=1>1×</option>
			<option value=1.25>1.3×</option>
			<option value=1.5>1.5×</option>
			<option value=1.75>1.8×</option>
			<option value=2>2×</option>
			<option value=0.8>0.8×</option>
		</select>
	</div>
	<div contenteditable="true" id="content"></div>
	<div id="buttons-container">
		<button id="clear">Clear</button>
		<button id="listen">Listen</button>
		<button id="share">Share</button>
	</div>
	
	<script>
		const speed = document.getElementById("speed");
		const dropDown = document.getElementById("drop-down");
		const content = document.getElementById("content");
		const recordButton = document.getElementById("listen");
		const clearConversation = document.getElementById("clear");
		const shareButton = document.getElementById("share");
		var isRecording = false;
		var mediaRecorder;
		var mediaStream;
		var recordedChunks = [];

		let key = new URLSearchParams(window.location.search).get('key');


		var messages = [];
		var tokens = 0;
		var modes = {
			'Concise factual': {pipeline: chat, params: {}, messages: {
				system: "You are a concise assistant that answers in a way that is easy to listen by reading. No formalities, appologies or confirmations. Informal tone of voice."}},
			'GPT4: Concise factual': {pipeline: chat, params: {'model': 'gpt-4', 'temperature': 0.5}, messages: {
				system: "You are a concise assistant that answers in a way that is easy to listen by reading. No formalities, appologies or confirmations. Informal tone of voice."}},
			'Translator': {pipeline: chat,  params: {'model': 'gpt-4', 'temperature': 0}, messages: {
				system: 
					`You are an accurate translator.
					- Translate between last 2 languages used.
					- If there was just 1 language used previously, translate to the other language from ({}).
					- No notes, explanations.
					- Do not mention what language did you translate to. 
					- Do not repeat the request for the translation.
					`,	
				user:
					`Example:
					Text: Translate to French. Nice to meet you. 
					Translation: Le français est une très belle langue.

					Translate the following text.

					Text:{}
					Translation:`, 
				remember: 2
				}},
			'Pohádkobot': {pipeline: chat, params: {'temperature': 1}, messages: {
				system: "Jsi pohádkový robot. Vyprávíš pohádky dětem na jejich přání. Pokud není řečeno jinak, vymysli pohádku přibližně o sedmi odstavcích."}},
			'Repeat what I say': {pipeline: speak}
		};
		var languages = "Czech, English";
		var page = 0;

		var wakelock = null;
				
		try { 
			setupUI();
		} catch (e) {log(e)}

		function setupUI() {
			try{ window.speechSynthesis.addEventListener('voiceschanged', getBestVoices) 
				getBestVoices();
			} catch {log("Your phone can not speak:(")}
			for(role in modes){
				let option = document.createElement('option');
				option.textContent = role;
				option.value = role;
				dropDown.appendChild(option);
			}
			clear();
		}

		document.addEventListener('touchstart', handleTouchStart, false);        
		document.addEventListener('touchend', handleTouchEnd, false);

		var touche = [0, 0];
		function handleTouchStart(evt) {                                         
			touche = [evt.touches[0].clientX, evt.touches[0].clientY];
		}

		function handleTouchEnd(evt) {
			var diff = [evt.changedTouches[0].clientX - touche[0], evt.changedTouches[0].clientY - touche[1]];

			if(diff[0]>100)
				flip(-1);
			else if(diff[0]<-100)
				flip(1);
		}

		function share(){
			if(content.innerHTML)
				if (navigator.share)
					navigator.share({text: content.innerHTML})
						.then(() => console.log('Successful share'))
						.catch((error) => console.log('Error sharing:', error));
				else navigator.clipboard.writeText(content.innerHTML);
		}

		function flip(p) {
			let systemMessages =( messages.length>0 && 'role' in messages[0] && messages[0]['role'] == 'system') ? 1 : 0;
			if(!page)
				page = messages.length-1;
			page += p;
			if(page < systemMessages)
				page = systemMessages; 
			if(page > messages.length)
				page = messages.length-1;
			if(page < messages.length && page >= systemMessages)
				show(messages[page]['content']);
		}

		var pressTimer;
		shareButton.addEventListener('touchstart', longTouch, {passive: false});
		shareButton.addEventListener('touchend', longShare, {passive: false});
		recordButton.addEventListener('touchstart', longTouch, {passive: false});
		recordButton.addEventListener('touchend', longListen, {passive: false});
		
		function longTouch(event){
			pressTimer = performance.now();
			event.preventDefault();
		}
		function longShare(event){
			if(performance.now() - pressTimer > 2000){
				try { (new Audio(URL.createObjectURL(recordedAudio)).play()) } catch {}
				event.preventDefault();
			}  else 
				event.target.click()
		}
		function longListen(event){
			if(performance.now() - pressTimer > 2000){
				try { 
					if(content.innerText)
						modes[dropDown.value].pipeline(content.innerText);
					else if (navigator.clipboard){
						navigator.clipboard.readText().then(clipText => {
							content.innerHTML = clipText;
							modes[dropDown.value].pipeline(clipText);
						});
					}
				} catch (e) {
					log(e)
				}
				event.preventDefault();
			}  else 
				event.target.click()
		}

		function log(text){
			content.innerHTML += text + " ";
		}
		function show(text){
			content.innerHTML = enhance4screen(text);
			shareButton.textContent = navigator.share ? 'Share' : 'Copy';
		}

		recordButton.addEventListener("click", () => {
			if (isRecording) 
				stopRecording();
			else if(wakelock){
					window.speechSynthesis.cancel();
					wakelock.release();
					wakelock = null;
					recordButton.textContent = "Listen";
				}else
					startRecording();
		});

		clearConversation.addEventListener("click", clear);
		dropDown.addEventListener("change", clear);
		shareButton.addEventListener("click", share);
		speed.addEventListener("change", testSpeed);


		function enhance4screen(text){
			text = text.replace(/\n/g, "<br/>\n");
			let pattern = /^(?:\s*)```([\s\S]*?)```\s*$/gm;
			return text.replace(pattern, '\n<pre><code>' + '$1' + '</code></pre>\n');
		}
		

		/// Synthesizer TODO: encapsulate

		function simplify2read(text){
			// remove code blocks
			let processed = text.replace(/(```.*?```)/gs, "Example code.\n");
			processed = processed.replace(/`/g, "'"); // it reads it as 'back quote'

			// decrease wokiness
			processed = processed.replace(/\b(\w{3,})\/á\b/g, '$1');

			return processed
		}


		const czechChars = /[ěščřžýáíéúůďťň]/i; 
		let voices = {}

		function getBestVoices(){
			window.speechSynthesis.getVoices().forEach(voice => {
				let lang = voice.lang.substring(0,2);
				if(! (lang in voices)){
					voices[lang] = voice;
				} else
					if(voice.name.toLowerCase().includes('premium')){
						voices[lang] = voice;
					}
			});
		}

		function getVoiceByLang(str) {
			const substring = str.substring(0, 100);
			if (czechChars.test(substring))
				return voices['cs'];
			else
				return voices['en'];
		}

		async function speak(text){
			if ('speechSynthesis' in window) {
				recordButton.textContent = "Shh!";
				let rate = speed.value;
				const utterance = new SpeechSynthesisUtterance();
				//msg.onend = () => {console.log('Speech ended.');};
				utterance.voice = getVoiceByLang(text);
				utterance.text = simplify2read(text);;
				utterance.rate = rate;

				utterance.onend = function(event) {
					if(wakelock)
						wakelock.release();
					wakelock = null;
					recordButton.textContent = "Listen";
				};

				window.speechSynthesis.speak(utterance);

			  } 
			  else 
				log("Your phone can't speak");
		}

		document.addEventListener("visibilitychange", function() {
			if (document.hidden) {	// lost focus
				//window.speechSynthesis.pause();
				window.speechSynthesis.resume();
			} 
		});

		function testSpeed(){
			let sel = speed.options[speed.selectedIndex].innerHTML;
			speak("The speed of speaking set to " + sel);
		}


		/// Recorder: TODO encapsulate
		
	  
		async function startRecording() {
			window.speechSynthesis.cancel();
			try {wakelock = await navigator.wakeLock.request('screen');} catch {}

			isRecording = true;
			recordButton.textContent = "STOP rec & Answer!";

			try {
				mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
				mediaRecorder = new MediaRecorder(mediaStream);
				recordedChunks = [];
				mediaRecorder.start();

				mediaRecorder.addEventListener('dataavailable', event => {
					if (event.data.size > 0)
						recordedChunks.push(event.data);
				});
			} catch (e) {
				log(e);
				speak(`Error while recording: ${e.name})`);
			}
		}

		var recordedAudio;
		async function stopRecording() {
			isRecording = false;
			recordButton.textContent = "…recognizing";
			mediaRecorder.stop();
			mediaStream.getTracks().forEach(track => track.stop()); // free resources

			try {  
				mediaRecorder.addEventListener("stop", async () => {
					let type = "audio/mpeg"; //audio/mpeg, audio/mp4, audio/x-m4a, not audio/webm
					let extension = ".mp3"
					const audioBlob = new Blob(recordedChunks, {type: type}); 
					//const audioUrl = URL.createObjectURL(audioBlob);
					recordedAudio = new File([audioBlob], "recordedAudio"+extension, {type: type});

					query = await transcribe(recordedAudio);
					
					if(query.hasOwnProperty('text')){	
						show(query.text);
						page = messages.length-1;
						modes[dropDown.value].pipeline(query.text)
					}
					if(query.hasOwnProperty('error')){
						log("Error: "+query['error']['message']);
						speak(query['error']['message']);
					}
				});
			} catch (e) {
				log("Can't save the recording");
				log(e);
			}
		}





		/// AI: TODO encapsulate


		async function transcribe(file){
			formData = new FormData();
			formData.append('file', file);
			formData.append('model', 'whisper-1')
			try {
				const transcription = await fetch("https://api.openai.com/v1/audio/transcriptions", {
					method: 'POST',
					headers: {
						'Authorization': "Bearer "+key //,"Content-Type": "multipart/form-data"
					},
					body: formData //,model: "whisper-1"
				});
				const query = await transcription.json();
				// error on iPhone: https://community.openai.com/t/whisper-api-cannot-read-files-correctly/93420
				return (query);
			} catch(e){
				log("Can't transcribe the recording");
				log(e);
				return {'error': {'message':"Error in voice recognition"}}
			}
		}

		function messageFromTemplate(role, text){
			try {
				template = modes[dropDown.value]['messages'][role];
				if(text)
					text = template.replace('{}', text);
				else
					text = template;
			} catch {}
			
			return {'role': role, 'content': text };
		}

		function keepLastMessages(){
			try{
				let keep = modes[dropDown.value]['messages']['remember'];
				if (keep < messages.length){
					messages = messages.splice(messages.length - keep);
					if('system' in modes[dropDown.value]['messages'])
						messages.unshift(messageFromTemplate('system', languages));
				}
			} catch {}
		}

		async function chat(question){
			messages.push(messageFromTemplate('user', question));
			recordButton.textContent = "…thinking";

			let params = modes[dropDown.value].params;
			if(!('model' in params))
				params.model = 'gpt-3.5-turbo';
			params.messages = messages;

			const response = await fetch("https://api.openai.com/v1/chat/completions", {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': 'Bearer '+key
				},
				body: JSON.stringify(params)
			});

			const reply = await response.json();

			try {
				message = reply['choices'][0]['message']
				messages.push(message);
				keepLastMessages();
				tokens = reply['usage']['total_tokens'];

				clearConversation.textContent = "Clear " + tokens + " words";
				show(message['content']);
				page = messages.length-1;
				speak(message['content']);
			} 
			catch (e) {
				if('error' in reply && 'message' in reply['error']){
					message = reply['error']['message'];
					show(message)
					speak(message)
				} else { 
					log(e); // name, message, stack
					speak(`Error ${e.name}`)
				}}
			
		}

		function clear(){
			try {
				messages = [messageFromTemplate('system', languages)];
			} 
			catch { 
				messages = []; }

			content.innerHTML = "";
			clearConversation.textContent = "";
			shareButton.textContent = ""
			tokens = 0;
		}

	</script>
</body>
</html>